<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="Taro3.2 适配 React Native 之样式内幕, Shin&#39;s blog">
    <meta name="description" content="会者定离，一期一祈">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>Taro3.2 适配 React Native 之样式内幕 | Shin&#39;s blog</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 5.2.0"><link rel="alternate" href="/atom.xml" title="Shin's blog" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">Shin&#39;s blog</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">Shin&#39;s blog</div>
        <div class="logo-desc">
            
            会者定离，一期一祈
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        
    </ul>
</div>


        </div>

        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/13.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">Taro3.2 适配 React Native 之样式内幕</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        height: calc(100vh - 250px);
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/Taro/">
                                <span class="chip bg-color">Taro</span>
                            </a>
                        
                            <a href="/tags/React-Native/">
                                <span class="chip bg-color">React Native</span>
                            </a>
                        
                            <a href="/tags/%E5%BC%80%E6%BA%90/">
                                <span class="chip bg-color">开源</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/React-Native/" class="post-category">
                                React Native
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2021-03-28
                </div>
                

                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    4.3k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    17 分
                </div>
                

                
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>从 Taro 3 开始，58同城成为 Taro 的战略合作伙伴，负责 Taro 3 React Native 部分的研发和推广。我们总结以往 JD Taro 同学们适配上的经验，以及内部对 React Native 使用的技术沉淀，为了能更好的提升开发体验，因此我们提出新的架构方案[0]。</p>
<p>在新的架构设计下，以往对样式处理的方案需要设计接入。在接入的过程中，需要考虑到 React-Native 的样式管理与样式的差异，框架提供对用户友好的兼容方案，以便在工程开发上更好的组织代码。</p>
<p>React-Native 的样式支持基本上是实现了 CSS 的一个子集，但属性名不完全一致。更大的不同是没有对层叠样式表支持，不能使用 class 读取静态样式，所以在跟 Web 的适配上有很大的困难。</p>
<h2 id="适配上的问题"><a href="#适配上的问题" class="headerlink" title="适配上的问题"></a>适配上的问题</h2><p>开始接入样式系统之前，先看一段代码</p>
<p>常见的 React Native 代码设置样式：</p>
<pre class="line-numbers language-jsx" data-language="jsx"><code class="language-jsx">import React from &quot;react&quot;;
import &#123; StyleSheet, Text, View &#125; from &quot;react-native&quot;;

const App &#x3D; () &#x3D;&gt; (
  &lt;View style&#x3D;&#123;styles.container&#125;&gt;
    &lt;Text style&#x3D;&#123;styles.title&#125;&gt;React Native&lt;&#x2F;Text&gt;
  &lt;&#x2F;View&gt;
);

const styles &#x3D; StyleSheet.create(&#123;
  container: &#123;
    flex: 1,
    backgroundColor: &quot;#eaeaea&quot;
  &#125;,
  title: &#123;
    fontSize: 30,
    fontWeight: &quot;bold&quot;
  &#125;
&#125;);

export default App;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>常见的 Taro 其他端代码设置样式：</p>
<pre class="line-numbers language-jsx" data-language="jsx"><code class="language-jsx">&#x2F;&#x2F; app.js
import React from &quot;react&quot;;
import &#123; Text, View &#125; from &quot;@tarojs&#x2F;components&quot;;
import &quot;.&#x2F;app.css&quot;;

const App &#x3D; () &#x3D;&gt; (
  &lt;View className&#x3D;&quot;container&quot;&gt;
    &lt;Text className&#x3D;&quot;title&quot;&gt;React Native&lt;&#x2F;Text&gt;
  &lt;&#x2F;View&gt;
);

export default App;

&#x2F;&#x2F; app.css
.container &#123;
  flex: 1;
  background-color: &quot;#eaeaea&quot;;
&#125;
.title &#123;
  font-size: 30;
  font-weight: &quot;bold&quot;;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>通过分析上面的代码，Taro 要适配 React Native 代码有以下及衍生的问题：</p>
<ol>
<li><p>React Native 代码（样式代码） 与其他平台样式管理的差异性</p>
<ol>
<li>React Native 样式只支持声明式 style 的写法</li>
<li>其他端比如小程序端既可以使用声明式 style ，又可以通过 class 读取导入的样式进行布局</li>
</ol>
</li>
<li><p>通用的样式文件怎么转换为对象</p>
</li>
<li><p>组件样式怎么传递</p>
<p> React Native 是用 style 进行传递，其他端使用 class。理论上从写法上约束，使三端更好的适配，CSS In JS 样式解决方案更适合。</p>
</li>
<li><p>React Native 支持的样式有限，不支持的样式怎么处理</p>
</li>
<li><p>平台型的特殊逻辑以及特殊样式怎么灵活处理</p>
<p> Taro 在处理跨端文件上有做过处理，但是只是针对脚本文件，我们希望能够对样式文件也能够进行跨端，并且希望在 ios 和 android 两个端的差异文件匹配。比如 Shadow 类样式，只能在 IOS 上生效，Android 则需使用 elevation 替代。当然可以通过重写，但有的时候工程化需求能更明确的区分这两端。</p>
</li>
</ol>
<h2 id="总体设计"><a href="#总体设计" class="headerlink" title="总体设计"></a>总体设计</h2><h4 id="流程图"><a href="#流程图" class="headerlink" title="流程图"></a>流程图</h4><p>样式适配设计流程图：</p>
<img src='https://tva1.sinaimg.cn/large/008eGmZEgy1gn5ncsrc1yj30u011agz4.jpg' style="width:400px;margin:0 auto 20px;display: block" />

<p>下面是流程释义，对应流程图标注。</p>
<p>核心流程：</p>
<ol>
<li>样式代码处理成对象<ol>
<li>CSS 样式解析成对象导出</li>
<li>引入样式文件处理成 JS 模块</li>
<li>引入多个样式文件处理</li>
</ol>
</li>
<li>样式校验</li>
<li>标签属性 className 处理成 style</li>
</ol>
<p>拓展补充流程：<br>4. 多种预编译语言的适配<br>5. 更灵活的跨平台工程适配</p>
<h2 id="设计实现"><a href="#设计实现" class="headerlink" title="设计实现"></a>设计实现</h2><h4 id="样式代码处理成对象"><a href="#样式代码处理成对象" class="headerlink" title="样式代码处理成对象"></a>样式代码处理成对象</h4><ul>
<li><p>CSS 样式解析成对象导出</p>
<p>  如果我们需要是样式文件在 React Native 能使用的话，首先需要将样式 CSS 处理成样式对象。在这里第一步将 CSS 解析成 AST 树[1]:</p>
  <pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token selector">body</span> <span class="token punctuation">&#123;</span>
    <span class="token property">background</span><span class="token punctuation">:</span> #eee<span class="token punctuation">;</span>
    <span class="token property">color</span><span class="token punctuation">:</span> #888<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

  <img src='https://tva1.sinaimg.cn/large/008eGmZEly1gn4k6lt2huj30kw0saq6o.jpg' style="width:200px;margin:0 auto;display: block" />

<p>  将解析出来的 AST rules（selector）进行遍历并且再对里面的 declarations（样式属性）遍历，使用 css-to-react-native[2] 将 CSS 属性转换成 React Native 的样式属性，在 selector 命名的对象设置转换后的属性值和属性名。最后用一个大的样式对象存储 selector 命名的对象。</p>
<p>  将样式处理成 JS 对象[3]：</p>
  <img src="https://tva1.sinaimg.cn/large/008eGmZEgy1gn5ng51rooj316m0a0q42.jpg" alt="image-20210106105551032" style="width:500px;margin:0 auto;display: block" />

<p>  这一步在源码实现上将 css-to-react-native 和 CSS parser 封装成 taro-css-to-react-native NPM 包。</p>
<p>  最后将转换后的样式对象导出：</p>
  <pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> StyleSheet <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'react-native'</span>
<span class="token keyword">const</span> cssObject <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token comment">/**/</span><span class="token punctuation">&#125;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> StyleSheet<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>cssObject<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>引入样式文件处理成 JS 模块</p>
<p>  Metro 是 Facebook 用来支持 React Native 的打包工具，它 打包有三个阶段，Resolution（模块解析器），Transformation（模块转换），Serialization（模块序列化），直译过来比较容易理解，大概能猜到要用它们做什么事。接下我们需将样式文件进行模块化解析和模块转换，对应的 Metro 配置里面的 resolver 和 transformer 配置项。</p>
<p>  resolver 配置处理模块解析，<code>sourceExts</code> 用来配置需要处理文件后缀，通过 js 引入进来的模块将会当作 JS 模块处理，这个机制让我们可以将样式文件依赖引入。</p>
<p>  接下来把导入进来样式文件，在 transformer 这层将样式内容转成 JS 语法，导出 JS 模块，这样就可以在文件中引入样式对象了。</p>
  <pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// metro.config.js</span>
<span class="token keyword">const</span> <span class="token punctuation">&#123;</span> getDefaultConfig <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"metro-config"</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> <span class="token punctuation">&#123;</span>
    resolver<span class="token operator">:</span> <span class="token punctuation">&#123;</span> sourceExts <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getDefaultConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
    resolver<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      sourceExts<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token operator">...</span>sourceExts<span class="token punctuation">,</span> <span class="token string">"scss"</span><span class="token punctuation">,</span> <span class="token string">"sass"</span><span class="token punctuation">]</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    transformer<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// 样式 transformer， 配置忽略了对其他文件的处理，实际上根据不同后缀使用不同的 transformer</span>
      babelTransformerPath<span class="token operator">:</span> require<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">"@tarojs/rn-style-transformer"</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>  将原来的样式代码字符串转成 JS 的代码字符串：</p>
  <pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> StyleSheet <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'react-native'</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> StyleSheet<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>cssObject<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>  然后可以从页面上引入样式模块：</p>
  <pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">import</span> a <span class="token keyword">from</span> <span class="token string">'a.css'</span>
<span class="token keyword">const</span> _stylesheet <span class="token operator">=</span> a<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
<li><p>引入多个样式文件处理</p>
<p>  引入一个样式文件时，我们不需要处理，只需将导出的对象赋值 <code>_stylesheet</code> 对象，然后在 <code>style</code> 属性进行引用。当引入多个样式文件时，要实现整个页面引入使用的样式生效，需要把多个样式合并成一个样式对象：</p>
  <pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">import</span> a <span class="token keyword">from</span> <span class="token string">'a.css'</span>
<span class="token keyword">import</span> b <span class="token keyword">from</span> <span class="token string">'b.css'</span>

<span class="token keyword">const</span> _stylesheet <span class="token operator">=</span> <span class="token function">mergeStyles</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>  要实现上面的功能，需要对 JS 代码处理，我们在 Babel 编译的时候定义 visitor 访问 importDeclaration 修改 AST 就可以了。<br>  下面是一段代码演示：</p>
  <pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token function">traverse</span><span class="token punctuation">(</span>codeAst<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token comment">// visitor</span>
  Program<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token parameter">ast</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> lastImportAst <span class="token operator">=</span> <span class="token function">findLastImport</span><span class="token punctuation">(</span>ast<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'body'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>styleList<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 插入到最后一个 import 后面</span>
        lastImportAst<span class="token punctuation">.</span><span class="token function">insertAfter</span><span class="token punctuation">(</span>template<span class="token punctuation">.</span><span class="token function">ast</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
          function mergeStyle() &#123;
            // 省略代码，实现 arguments 对象的合并，返回合并的对象
          &#125;
          const _styleSheet = mergeStyle(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>styleList<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">)
        </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token comment">// 访问 importDeclaration ast</span>
  <span class="token function">ImportDeclaration</span><span class="token punctuation">(</span><span class="token parameter">ast</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> source <span class="token punctuation">&#125;</span> <span class="token operator">=</span> path<span class="token punctuation">.</span>node
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isStyle</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span>

    ast<span class="token punctuation">.</span>node<span class="token punctuation">.</span>specifiers<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">node</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// 导出的 default</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">isImportDefaultSpecifier</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        styleList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>local<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

</li>
</ul>
<h4 id="标签属性-className-处理成-style"><a href="#标签属性-className-处理成-style" class="headerlink" title="标签属性 className 处理成 style"></a>标签属性 className 处理成 style</h4><p>上面讲到的文件导入处理，以及多文件合并都是用 Babel 插件去实现的，将 className 处理成 style 也是通过 AST 修改 jsxElement 的属性。下面是插件实现属性转换的核心逻辑：</p>
<ul>
<li><p>className 是一个普通字符串</p>
<p>  这一步比较好办，直接把 <code>&lt;View className=&#39;red&#39; /&gt;</code> 转化成 <code>&lt;View style=&#123;_styleSheet[&#39;red&#39;]&#125; /&gt;</code>。</p>
</li>
<li><p>className 是一个表达式</p>
<p>  className 如果是复杂表达式（比如函数调用等非 JS 基本类型）的话，在 Babel 编译时是无法处理这种结果的，所以得借助运行时方法去处理。这里 我们实现了一个 getStyle 函数，参数传入 className 表达式，在运行时得到表达式的值再去 _styleSheet 里面取出样式对象。代码层将 <code>&lt;View className=&#123;&#39;red&#39;&#125; /&gt;</code> 转化成 <code>&lt;View className=&#123;getStyle(&#39;red&#39;)&#125; /&gt;</code>。</p>
</li>
<li><p>className 和 style 属性同时存在 </p>
<p>  同时存在这两种属性时，将两者的值进行合并。React Native 标签 style 属性支持数组对象，所以可以把 <code>&lt;View className=&#39;red&#39; style=&#123;&#123; width: 100 &#125;&#125; /&gt; </code> 处理成 <code>&lt;View style=[&#123;color: &#39;red&#39;&#125;, &#123; width: 100 &#125;] /&gt;</code> 。 </p>
<p>  实现下面核心逻辑的代码演示：</p>
  <pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token function">JSXOpeningElement</span><span class="token punctuation">(</span><span class="token parameter">jsxPath</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> attributes <span class="token punctuation">&#125;</span> <span class="token operator">=</span> jsxPath<span class="token punctuation">.</span>node
  <span class="token keyword">const</span> styleNode <span class="token operator">=</span> attributes<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token parameter">node</span> <span class="token operator">=></span> node<span class="token punctuation">.</span>name<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">'style'</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> classNode <span class="token operator">=</span> attributes<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token parameter">node</span> <span class="token operator">=></span> node<span class="token punctuation">.</span>name<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">'className'</span><span class="token punctuation">)</span>
  <span class="token comment">// 存在 className 属性</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>classNode<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 删除 className 属性</span>
    attributes<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>attributes<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>classNode<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> class2StyleExpression <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token comment">// className 表达式</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">isJSXExpressionContainer</span><span class="token punctuation">(</span>classNode<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> value <span class="token punctuation">&#125;</span> <span class="token operator">=</span> classNode<span class="token punctuation">.</span>value<span class="token punctuation">.</span>expression
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> value<span class="token punctuation">.</span>expression<span class="token punctuation">.</span>value <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// className=&#123;'red black'&#125; => style=&#123;[_stylesheet['red'], _stylesheet['black']]&#125;</span>
        class2StyleExpression <span class="token operator">=</span> value<span class="token punctuation">.</span>expression<span class="token punctuation">.</span>value <span class="token operator">===</span> <span class="token string">''</span> <span class="token operator">?</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token function">getMap</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span>expression<span class="token punctuation">.</span>value<span class="token punctuation">)</span> <span class="token comment">// getMap() 返回数组表达式，自行实现</span>
      <span class="token punctuation">&#125;</span>
      <span class="token comment">// 标记需要在运行时动态计算 className 值</span>
      <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// className=&#123;expression&#125; => style=&#123;getStyle(expression)&#125;</span>
        class2StyleExpression <span class="token operator">=</span> <span class="token punctuation">[</span>t<span class="token punctuation">.</span><span class="token function">callExpression</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">identifier</span><span class="token punctuation">(</span><span class="token string">'getStyle'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>value<span class="token punctuation">.</span>value<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        <span class="token comment">// TODO: 标记最后一个 import 后面插入 getStyle 函数，在 Program exit 时处理</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// className 是字符串</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">isStringLiteral</span><span class="token punctuation">(</span>classNode<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      class2StyleExpression <span class="token operator">=</span> classNode<span class="token punctuation">.</span>value <span class="token operator">===</span> <span class="token string">''</span> <span class="token operator">?</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token function">getMap</span><span class="token punctuation">(</span>classNode<span class="token punctuation">.</span>value<span class="token punctuation">.</span>value<span class="token punctuation">)</span> <span class="token comment">// getMap() 返回数组表达式</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 存在 style</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>styleNode <span class="token operator">&amp;&amp;</span> t<span class="token punctuation">.</span><span class="token function">isJSXExpressionContainer</span><span class="token punctuation">(</span>styleNode<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> expression <span class="token punctuation">&#125;</span> <span class="token operator">=</span> styleNode<span class="token punctuation">.</span>value
      <span class="token comment">// style=&#123;[&#123; &#125;]&#125; 表达式</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>expression<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'ArrayExpression'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        expression<span class="token punctuation">.</span>elements <span class="token operator">=</span> class2StyleExpression<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>expression<span class="token punctuation">.</span>elements<span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span>
      <span class="token comment">// style=&#123;&#123; &#125;&#125; 表达式</span>
      <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>expression<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'ObjectExpression'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        styleNode<span class="token punctuation">.</span>value <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">jSXExpressionContainer</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">arrayExpression</span><span class="token punctuation">(</span>class2StyleExpression<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>expression<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 不存在则新增 style 属性</span>
    <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
      attributes<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">jSXAttribute</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">jSXIdentifier</span><span class="token punctuation">(</span><span class="token string">'style'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span><span class="token function">jSXExpressionContainer</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">arrayExpression</span><span class="token punctuation">(</span>class2StyleExpression<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>  还有其他场景感兴趣的同学请查看 babel-plugin-transform-react-jsx-to-rn-stylesheet 测试用例[4]。</p>
<p>  即使实现这种方式的转换，但仍然可能跟 Web 的样式呈现不一样：</p>
  <pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token comment">/* app.css */</span>
<span class="token selector">.black</span> <span class="token punctuation">&#123;</span>
    <span class="token property">color</span><span class="token punctuation">:</span> red<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token selector">.red</span> <span class="token punctuation">&#123;</span>
    <span class="token property">color</span><span class="token punctuation">:</span> red<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

  <pre class="line-numbers language-jsx" data-language="jsx"><code class="language-jsx">&lt;View className&#x3D;&#39;red black&#39; &#x2F;&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>  在 Web 端：</p>
  <pre class="line-numbers language-jsx" data-language="jsx"><code class="language-jsx">&lt;div class&#x3D;&#39;red black&#39; &#x2F;&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>  而 React Native 端处理成了：</p>
  <pre class="line-numbers language-jsx" data-language="jsx"><code class="language-jsx">&lt;View style&#x3D;&#123;[stylesheet.red, stylesheet.black]&#125; &#x2F;&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>  细心的同学可能发现问题了，在 Web 端的，class 跟样式文件的定义样式的顺序有关，跟标签的 class 属性书写顺序无关，而在 React Native，却跟 class（处理成 style）的顺序有关。这个问题，现阶段只能在代码层去规避，还没有想到很好的方法去解决。</p>
</li>
</ul>
<p>以上讲的是如何将一般的 CSS 语法的文件处理成 React Native 标签的 style 属性能接收到的样式对象，而在实际开发生产时，样式预处理器更为推荐使用，毕竟优秀的语法糖能提高劳动人民的生产力。</p>
<h4 id="多种预编译语言的适配"><a href="#多种预编译语言的适配" class="headerlink" title="多种预编译语言的适配"></a>多种预编译语言的适配</h4><ul>
<li><p>Sass</p>
<p>  这个版本的做法是基于 node-sass 解析 Sass 语法，内部调用 node-sass 提供的 API render 函数，并且提供一些 options 配置。跟 sass-loader[5] 类似，但只暴露了 options 和 additionalData 两个配置项。</p>
<p>  additionalData是一个全局配置，插入一段代码到引入的 Sass 文件中。而 config.sass 也是一个全局配置，他们之间是有关联的。addtionalData 在编译时注入的每个 Sass 文件头部，在 config.sass 配置的全局样式之前，就是说 config.sass 可以把 addtionalData 样式重写掉，或者可以复用 addtionalData 的变量。</p>
<p>  sass-loader 配置里面的有一个 implementation 配置，该配置能选择使用 dart-sass 实现 Sass 的解析，但是目前这个版本还没有支持到，所以目前还不能启用 dart-sass 解析。node-sass[6] 依赖 node-gyp 和 python2，官方不建议使用，不会有新特性的更新，取而代之的是使用 dart-sass[7]。这个库完全兼容 node-sass，官方介绍的更易安装，更容易集成到现代 Web 开发工作流程中。所以 Taro React Native 后面版本会支持到 implementation 配置。</p>
</li>
<li><p>Less，Stylus</p>
<p>  像 less-loader 一样，Less 处理需要封装 less.js  提供的 api render 函数，以及封装自定义 options 和 addtionalData 处理。</p>
  <pre class="line-numbers language-js" data-language="js"><code class="language-js">less<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
  <span class="token operator">...</span>options<span class="token punctuation">,</span>
  filename<span class="token punctuation">,</span>
  plugins<span class="token operator">:</span> plugins<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>plugins <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  paths<span class="token operator">:</span> paths<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>paths <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> output</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span>output<span class="token punctuation">.</span>css<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>   Stylus 支持也跟 Sass Less 类似，提供 options 和 additionalData 两个配置项，将 Stylus 语法解析成标准的 CSS。</p>
</li>
<li><p>PostCSS</p>
<p>  PostCSS 不是类似上述预处理器，而是一种允许用 JS 插件来转变样式的工具。在源码里面我们对内置默认插件进行了封装，最后使用 postcss 库进行解析。</p>
</li>
</ul>
<h4 id="校验样式"><a href="#校验样式" class="headerlink" title="校验样式"></a>校验样式</h4><ul>
<li><p>校验样式写法</p>
<p>  在设计的过程中，所有的样式文件都经过预处理语言 PostCSS 处理，这样可以把一些公共事务集中处理，比如 stylelint，条件编译，单位处理等等。样式 stylelint 检测是用来校验样式写法，使用 stylelint 插件，通过 stylelint-config-taro-rn[9] 配置 规则来约束不支持的样式写法，比如校验组合选择器。</p>
</li>
<li><p>校验样式对象</p>
<p>  React Native 支持的样式有限，写入一些不支持的样式将会导致应用报错或者闪退，所以我们需要一个功能去校验代码，在控制台打印样式错误日志。</p>
<p>  当写了一个不支持的样式属性 <code>o</code> 时：</p>
  <img src='https://tva1.sinaimg.cn/large/008eGmZEly1gn4higfqvej30k60vswhp.jpg' style='width:300px;margin: 0 auto;display: block' />

<p>  在控制台给用户提示报错信息：</p>
  <img src='https://tva1.sinaimg.cn/large/008eGmZEly1gn4hmacxpej318o054gnh.jpg' style='width:600px;margin: 0 auto;display: block' />

</li>
</ul>
<h4 id="更灵活的跨平台工程适配"><a href="#更灵活的跨平台工程适配" class="headerlink" title="更灵活的跨平台工程适配"></a>更灵活的跨平台工程适配</h4><ul>
<li><p>跨平台文件</p>
<p>  在文章开始的是提到过，我们需要更灵活的去匹配不同平台的文件（包括样式文件），并且希望区分 IOS 和 Android 两端的文件。</p>
<p>  实现上面最先想到的是用 Babel 插件去实现，因为 Babel 去修改 import 声非常简单。但是在实现的一两个版本里面，发现他有很严重的副作用，就是缓存问题。因为 Metro 对所有源文件进行了编译缓存，如果没有改动的话将读缓存的内容而不会默认重新编译，而 Babel 本质上是对代码的转化。当新增一个 跨平台优先级高的文件时，文件没有改动，并且没有打破文件依赖关系，所以不会重新编译的问题。但正是这个缓存机制，Metro 才有快速启动的优势。</p>
<p>  后面我们决定在 Resolution（模块解析器）在一层 去实现不同跨平台文件引入，将对样式文件和脚本文件都做跨平台处理。</p>
  <pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">handleFile</span> <span class="token punctuation">(</span><span class="token parameter">context<span class="token punctuation">,</span> realModuleName<span class="token punctuation">,</span> platform<span class="token punctuation">,</span> moduleName</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 返回新的模块名，根据平台，文件路径和引入的模块</span>
    moduleName <span class="token operator">=</span> <span class="token function">resolveExtFile</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> moduleName<span class="token punctuation">,</span> platform<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li>
<li><p>跨平台样式</p>
<p>  在一段样式代码内，希望区分小程序，H5 和 其他平台的场景时， 则需使用条件编译。条件编译是根据编译时的环境变量，对 CSS AST 内容的进行解析，决定对条件内的代码采用或者忽略，使用的是已有 PostCSS 插件 postcss-pxtransform[10] 实现。</p>
  <pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token comment">/*  #ifndef  %PLATFORM%  */</span>
<span class="token comment">/* 平台特有样式 */</span>
<span class="token comment">/*  #endif  */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

</li>
</ul>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>通过使用上面的一些技术手段，在 Taro 开发 React Native 过程中相对而言可以有一个比较好的体验。但在 React Native style 属性作为样式管理限制下，其他端样式的适配上仍有限制。</p>
<ol>
<li><p>未来优化的方向和目前仍存在的样式限制 - 选择器的约束</p>
<ol>
<li><p>在 JSX 这一层，只对了 className 进行 style 的转换，这个限制造成了在选择器上只能使用类选择器。</p>
</li>
<li><p>在 CSS 转成对象这一层，直接将类选择器转化成对象，没有对组合选择器支持，限制了组合选择器的使用。</p>
</li>
<li><p>在预处理语言嵌套写法中，也不能使用会编译成组合选择器的写法，但是可以使用能编译成 BEM[11] 的嵌套写法。</p>
</li>
</ol>
</li>
<li><p>关于组合选择器的一点思考</p>
<ol>
<li><p>Atomic CSS</p>
<p> Atomic CSS[12] 是今年5月 Facebook 提出来的对样式管理的方案，官方号称使用了 Atomic CSS 将主页 CSS 代码量减少了80％，感兴趣的同学可以访问 Facebook 主页查看。</p>
 <img src='https://tva1.sinaimg.cn/large/008eGmZEly1gn4mor24dcj30tf0dd78w.jpg' width='600' />

<p> Atomic CSS 是指给每一个样式属性设置都对应一个类选择器去控制，避免重复的样式代码。比如使用了一个公共样式，只想使用其部分样式，则将增加一个层级（后代选择器）去重写不想使用的样式，在一定程度上增加了代码量。如果项目的样式都用 Atomic CSS ，那么组合选择器的支持就显得没那么必要了。</p>
</li>
<li><p>CSS in JS</p>
<p> CSS in JS[13] 是使用语法糖，在 JS 里面定义样式，本质上是用内联的方式写样式，这跟 React Native 样式管理理念一致，不失为 CSS in JS 爱好者推崇。但在小程序官方有提到， style 接收动态的样式，在运行时会进行解析，会影响渲染速度。</p>
</li>
</ol>
</li>
</ol>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p>[0] <a target="_blank" rel="noopener" href="https://github.com/NervJS/taro-rfcs/pull/8">https://github.com/NervJS/taro-rfcs/pull/8</a></p>
<p>[1] <a target="_blank" rel="noopener" href="https://www.npmjs.com/package/css">https://www.npmjs.com/package/css</a></p>
<p>[2] <a target="_blank" rel="noopener" href="https://github.com/styled-components/css-to-react-native">https://github.com/styled-components/css-to-react-native</a></p>
<p>[3] <a target="_blank" rel="noopener" href="https://csstox.surge.sh/">https://csstox.surge.sh/</a></p>
<p>[4] <a target="_blank" rel="noopener" href="https://github.com/NervJS/taro/blob/feat%2Freact-native/packages/babel-plugin-transform-react-jsx-to-rn-stylesheet/__tests__/index.spec.js">https://github.com/NervJS/taro/blob/feat%2Freact-native/packages/babel-plugin-transform-react-jsx-to-rn-stylesheet/<strong>tests</strong>/index.spec.js</a></p>
<p>[5] <a target="_blank" rel="noopener" href="https://github.com/webpack-contrib/sass-loader">https://github.com/webpack-contrib/sass-loader</a></p>
<p>[6] <a target="_blank" rel="noopener" href="https://github.com/sass/node-sass">https://github.com/sass/node-sass</a></p>
<p>[7] <a target="_blank" rel="noopener" href="https://github.com/sass/dart-sass">https://github.com/sass/dart-sass</a></p>
<p>[8] <a target="_blank" rel="noopener" href="https://www.npmjs.com/package/postcss-pxtransform">https://www.npmjs.com/package/postcss-pxtransform</a></p>
<p>[9] <a target="_blank" rel="noopener" href="https://www.npmjs.com/package/stylelint-config-taro-rn">https://www.npmjs.com/package/stylelint-config-taro-rn</a></p>
<p>[10] <a target="_blank" rel="noopener" href="https://www.npmjs.com/package/postcss-pxtransform">https://www.npmjs.com/package/postcss-pxtransform</a></p>
<p>[11] <a target="_blank" rel="noopener" href="http://getbem.com/naming/">http://getbem.com/naming/</a></p>
<p>[12] <a target="_blank" rel="noopener" href="https://engineering.fb.com/2020/05/08/web/facebook-redesign">https://engineering.fb.com/2020/05/08/web/facebook-redesign</a></p>
<p>[13] <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/CSS-in-JS">https://en.wikipedia.org/wiki/CSS-in-JS</a></p>

            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">Shin</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://shinken008.github.io/2021/03/28/taro3-2-gua-pei-react-native-zhi-yang-shi-nei-mu/">https://shinken008.github.io/2021/03/28/taro3-2-gua-pei-react-native-zhi-yang-shi-nei-mu/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">Shin</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/Taro/">
                                    <span class="chip bg-color">Taro</span>
                                </a>
                            
                                <a href="/tags/React-Native/">
                                    <span class="chip bg-color">React Native</span>
                                </a>
                            
                                <a href="/tags/%E5%BC%80%E6%BA%90/">
                                    <span class="chip bg-color">开源</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
        </div>
    </div>

    

    

    
        <div class="disqus-card card" data-aos="fade-up">
    <div id="disqus_thread" class="card-content">
        <noscript>Please enable JavaScript to view the
            <a target="_blank" rel="noopener" href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
    </div>
</div>

<script type="text/javascript">
    disqus_config = function () {
        this.page.url = 'https://shinken008.github.io/2021/03/28/taro3-2-gua-pei-react-native-zhi-yang-shi-nei-mu/';
        this.page.identifier = '/2021/03/28/taro3-2-gua-pei-react-native-zhi-yang-shi-nei-mu/';
        this.page.title = 'Taro3.2 适配 React Native 之样式内幕';
    };
    let disqus_shortname = 'shinken008';

    (function () { // DON'T EDIT BELOW THIS LINE
        let d = document, s = d.createElement('script');
        // 如：s.src = 'https://blinkfox.disqus.com/embed.js';
        s.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="far fa-dot-circle"></i>&nbsp;本篇
            </div>
            <div class="card">
                <a href="/2021/03/28/taro3-2-gua-pei-react-native-zhi-yang-shi-nei-mu/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/13.jpg" class="responsive-img" alt="Taro3.2 适配 React Native 之样式内幕">
                        
                        <span class="card-title">Taro3.2 适配 React Native 之样式内幕</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            背景从 Taro 3 开始，58同城成为 Taro 的战略合作伙伴，负责 Taro 3 React Native 部分的研发和推广。我们总结以往 JD Taro 同学们适配上的经验，以及内部对 React Native 使用的技术沉淀，为了
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2021-03-28
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/React-Native/" class="post-category">
                                    React Native
                                </a>
                            
                            
                        </span>
                    </div>
                </div>

                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Taro/">
                        <span class="chip bg-color">Taro</span>
                    </a>
                    
                    <a href="/tags/React-Native/">
                        <span class="chip bg-color">React Native</span>
                    </a>
                    
                    <a href="/tags/%E5%BC%80%E6%BA%90/">
                        <span class="chip bg-color">开源</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2020/10/21/babel-plugin-kai-fa-ri-ji-yi/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/12.jpg" class="responsive-img" alt="Babel/plugin 开发日记一">
                        
                        <span class="card-title">Babel/plugin 开发日记一</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            traverse 开始遍历 https://github.com/babel/babel/blob/86f535b8635e780d0707c47ae03658de27ae08bd/packages/babel-core/src/trans
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2020-10-21
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Babel/" class="post-category">
                                    Babel
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Babel/">
                        <span class="chip bg-color">Babel</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: Shin&#39;s blog<br />'
            + '文章作者: Shin<br />'
            + '文章链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


<!-- 代码块折行 -->

<style type="text/css">
code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }
</style>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
    <div class="container row center-align" style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            <span id="year">2019</span>
            <a href="/about" target="_blank">Shin</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            
            <br>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/shinken008" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:shinke008@gmail.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>













</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/search.xml", 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
